<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ LLM Rover Control</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
            margin: 0;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            background: linear-gradient(45deg, #2196F3, #21CBF3);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .calibration-info {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ff9800;
            margin-bottom: 20px;
        }
        
        .calibration-info h4 {
            margin-top: 0;
            color: #ff9800;
        }
        
        .card {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            border: 1px solid #444;
        }
        
        .form-group {
            margin: 15px 0;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #ccc;
            font-weight: 500;
        }
        
        input, textarea {
            width: 100%;
            padding: 10px;
            background: #333;
            border: 1px solid #555;
            border-radius: 5px;
            color: #fff;
            box-sizing: border-box;
        }
        
        textarea {
            height: 100px;
            font-family: monospace;
            resize: vertical;
        }
        
        .btn {
            padding: 12px 20px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        
        .btn:hover {
            background: #1976D2;
        }
        
        .btn:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .btn-danger {
            background: #f44336;
        }
        
        .btn-danger:hover {
            background: #d32f2f;
        }
        
        .btn-small {
            padding: 8px 12px;
            font-size: 14px;
        }
        
        .btn-success {
            background: #4caf50;
        }
        
        .btn-success:hover {
            background: #388e3c;
        }

        .btn-voice {
            background: #9c27b0;
        }

        .btn-voice:hover {
            background: #7b1fa2;
        }

        .btn-voice.recording {
            background: #f44336;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        .control-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            max-width: 200px;
            margin: 20px auto;
        }
        
        .control-btn {
            width: 60px;
            height: 60px;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .directional-control {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 30px auto;
            background: radial-gradient(circle, #333 60%, #1a1a1a 100%);
            border-radius: 50%;
            border: 2px solid #555;
        }

        .direction-btn {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #2196F3;
            color: white;
            border: 2px solid #1976D2;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.2s;
        }

        .direction-btn:hover {
            background: #1976D2;
            transform: scale(1.1);
        }

        .direction-btn:active {
            transform: scale(0.95);
        }

        /* Position buttons in circle */
        .dir-0 { top: 0; left: 50%; transform: translateX(-50%); }
        .dir-45 { top: 15%; right: 15%; }
        .dir-90 { top: 50%; right: 0; transform: translateY(-50%); }
        .dir-135 { bottom: 15%; right: 15%; }
        .dir-180 { bottom: 0; left: 50%; transform: translateX(-50%); }
        .dir-225 { bottom: 15%; left: 15%; }
        .dir-270 { top: 50%; left: 0; transform: translateY(-50%); }
        .dir-315 { top: 15%; left: 15%; }

        .center-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            background: #f44336;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .output {
            background: #1a1a1a;
            border: 1px solid #555;
            padding: 15px;
            border-radius: 5px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
            font-size: 13px;
        }
        
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .status.success { background: #4caf50; }
        .status.error { background: #f44336; }
        .status.warning { background: #ff9800; }
        .status.info { background: #2196f3; }
        
        .preset-commands {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 15px 0;
        }
        
        .preset-btn {
            padding: 8px 12px;
            background: #444;
            border: 1px solid #666;
            border-radius: 15px;
            color: #fff;
            cursor: pointer;
            font-size: 12px;
        }
        
        .preset-btn:hover {
            background: #555;
        }
        
        .duration-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
        }
        
        .duration-control input {
            width: 80px;
        }
        
        .info-badge {
            display: inline-block;
            background: #ff9800;
            color: #000;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 8px;
        }

        .image-upload-area {
            border: 2px dashed #555;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            background: #333;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .image-upload-area:hover {
            border-color: #2196F3;
            background: #3a3a3a;
        }

        .image-upload-area.dragover {
            border-color: #4caf50;
            background: #2d4a2d;
        }

        .image-preview {
            max-width: 100%;
            max-height: 400px;
            margin: 15px auto;
            display: none;
            border-radius: 8px;
            border: 1px solid #555;
        }

        .image-info {
            background: #1a1a1a;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 12px;
            display: none;
        }

        .analyzed-image {
            position: relative;
            display: none;
            margin: 15px 0;
        }

        .analyzed-image canvas {
            max-width: 100%;
            border: 2px solid #4caf50;
            border-radius: 8px;
        }

        .analysis-legend {
            background: #2a2a2a;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            margin-right: 10px;
            border: 1px solid #555;
        }

        .area-config {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 15px 0;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            border-bottom: 2px solid #444;
            padding-bottom: 10px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 10px 20px;
            background: #333;
            border: none;
            color: #ccc;
            cursor: pointer;
            border-radius: 5px 5px 0 0;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background: #2196F3;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .voice-controls {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ LLM Rover Control</h1>
            <p>AI-Powered Navigation with Voice, Image & Directional Control</p>
        </div>

        <div class="calibration-info">
            <h4>‚öôÔ∏è System Status</h4>
            <p style="margin: 5px 0;">All movements: <strong>100% speed</strong> | Turn calibration: <strong>Active on Pi</strong></p>
            <p style="margin: 5px 0; font-size: 12px; color: #aaa;">Voice commands, 8-direction control, and image analysis available</p>
        </div>

        <div class="card">
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="switchTab('text')">üí¨ Text</button>
                <button class="tab-btn" onclick="switchTab('voice')">üé§ Voice</button>
                <button class="tab-btn" onclick="switchTab('image')">üñºÔ∏è Image</button>
                <button class="tab-btn" onclick="switchTab('directional')">üß≠ Directional</button>
                <button class="tab-btn" onclick="switchTab('manual')">‚öôÔ∏è Manual</button>
            </div>

            <!-- Text Command Tab -->
            <div id="text-tab" class="tab-content active">
                <h3>üó£Ô∏è Natural Language Control</h3>
                
                <div class="form-group">
                    <label>Tell your rover what to do:</label>
                    <textarea id="user-prompt" placeholder="Examples:
‚Ä¢ Move forward for 2 seconds
‚Ä¢ Forward 1 sec, turn left, forward 1.5 sec
‚Ä¢ Go to 45 degrees for 3 seconds">Move forward for 2 seconds</textarea>
                </div>

                <div class="preset-commands">
                    <div class="preset-btn" onclick="setPrompt('move forward for 2 seconds')">Forward 2s</div>
                    <div class="preset-btn" onclick="setPrompt('turn left')">Turn Left</div>
                    <div class="preset-btn" onclick="setPrompt('turn right')">Turn Right</div>
                    <div class="preset-btn" onclick="setPrompt('move backward for 2 seconds')">Backward 2s</div>
                </div>

                <button class="btn" id="send-command" onclick="sendTextCommand()" style="width: 100%;">
                    üöÄ Send Command
                </button>
            </div>

            <!-- Voice Command Tab -->
            <div id="voice-tab" class="tab-content">
                <h3>üé§ Voice Navigation</h3>
                
                <div style="background: #2d4a2d; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 3px solid #4caf50;">
                    <strong>‚úÖ Voice Commands Supported:</strong><br>
                    ‚Ä¢ "Move forward for 2 seconds"<br>
                    ‚Ä¢ "Turn left"<br>
                    ‚Ä¢ "Go to 45 degrees"<br>
                    ‚Ä¢ "Stop"<br>
                    ‚Ä¢ Any natural language navigation command
                </div>

                <div class="voice-controls">
                    <button class="btn btn-voice" id="voice-btn" onclick="toggleVoiceRecording()" style="flex: 1;">
                        üé§ Hold to Speak
                    </button>
                    <button class="btn" onclick="testSpeechRecognition()" style="flex: 0;">
                        üîß Test Mic
                    </button>
                </div>

                <div id="voice-status" style="background: #333; padding: 15px; border-radius: 8px; margin: 15px 0; min-height: 60px;">
                    <strong>Status:</strong> <span id="voice-status-text">Ready to listen...</span><br>
                    <strong>Recognized:</strong> <span id="voice-transcript" style="color: #4caf50;">None</span>
                </div>

                <div style="font-size: 12px; color: #888; margin-top: 10px;">
                    üí° Tip: Speak clearly and wait for the beep. Works best in Chrome browser.
                </div>
            </div>

            <!-- Image Navigation Tab -->
            <div id="image-tab" class="tab-content">
                <h3>üñºÔ∏è Image-Based Navigation</h3>
                
                <div class="form-group">
                    <label>Upload Area Map (JPG, JPEG, PNG):</label>
                    <div class="image-upload-area" id="dropArea" onclick="document.getElementById('imageInput').click()">
                        <p>üì§ Click to upload or drag & drop image here</p>
                        <p style="font-size: 12px; color: #888;">Supported: JPG, JPEG, PNG</p>
                    </div>
                    <input type="file" id="imageInput" accept="image/jpeg,image/jpg,image/png" style="display: none;" onchange="handleImageUpload(event)">
                    
                    <img id="imagePreview" class="image-preview" alt="Preview">
                    
                    <div id="imageInfo" class="image-info">
                        <strong>Image loaded:</strong> <span id="imageName"></span><br>
                        <strong>Size:</strong> <span id="imageSize"></span><br>
                        <strong>Dimensions:</strong> <span id="imageDimensions"></span>
                    </div>

                    <!-- Analysis visualization -->
                    <div id="analyzedImage" class="analyzed-image">
                        <canvas id="analysisCanvas"></canvas>
                        <div class="analysis-legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background: #00ff00;"></div>
                                <span>ü§ñ Rover Position</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #ff0000;"></div>
                                <span>üéØ Goal/Target</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: rgba(255, 165, 0, 0.3);"></div>
                                <span>‚ö†Ô∏è Obstacles Detected</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="area-config">
                    <div class="form-group">
                        <label>Area Width (meters):</label>
                        <input type="number" id="areaWidth" value="2.5" step="0.5" min="1" max="10">
                    </div>
                    <div class="form-group">
                        <label>Area Height (meters):</label>
                        <input type="number" id="areaHeight" value="2.5" step="0.5" min="1" max="10">
                    </div>
                </div>

                <div class="form-group">
                    <label>Navigation Instructions:</label>
                    <textarea id="nav-instructions" placeholder="Navigate to the red marker avoiding obstacles">Navigate from rover position to goal avoiding all obstacles</textarea>
                </div>

                <button class="btn btn-success" id="analyze-image-btn" onclick="analyzeImage()" style="width: 100%; margin-bottom: 10px;">
                    üîç Step 1: Analyze Image
                </button>

                <button class="btn" id="send-image-command" onclick="sendImageCommand()" style="width: 100%;" disabled>
                    üó∫Ô∏è Step 2: Execute Navigation
                </button>
            </div>

            <!-- Directional Control Tab -->
            <div id="directional-tab" class="tab-content">
                <h3>üß≠ 8-Direction Control</h3>
                
                <div class="duration-control">
                    <label style="margin: 0;">Movement Duration:</label>
                    <input type="number" id="direction-duration" value="2" min="0.5" max="10" step="0.5">
                    <span>seconds</span>
                </div>

                <div class="directional-control">
                    <button class="direction-btn dir-0" onclick="moveDirection(0)" title="0¬∞ - North">
                        0¬∞<br>‚Üë
                    </button>
                    <button class="direction-btn dir-45" onclick="moveDirection(45)" title="45¬∞ - Northeast">
                        45¬∞<br>‚Üó
                    </button>
                    <button class="direction-btn dir-90" onclick="moveDirection(90)" title="90¬∞ - East">
                        90¬∞<br>‚Üí
                    </button>
                    <button class="direction-btn dir-135" onclick="moveDirection(135)" title="135¬∞ - Southeast">
                        135¬∞<br>‚Üò
                    </button>
                    <button class="direction-btn dir-180" onclick="moveDirection(180)" title="180¬∞ - South">
                        180¬∞<br>‚Üì
                    </button>
                    <button class="direction-btn dir-225" onclick="moveDirection(225)" title="225¬∞ - Southwest">
                        225¬∞<br>‚Üô
                    </button>
                    <button class="direction-btn dir-270" onclick="moveDirection(270)" title="270¬∞ - West">
                        270¬∞<br>‚Üê
                    </button>
                    <button class="direction-btn dir-315" onclick="moveDirection(315)" title="315¬∞ - Northwest">
                        315¬∞<br>‚Üñ
                    </button>
                    <div class="center-indicator">ü§ñ</div>
                </div>

                <p style="text-align: center; color: #888; font-size: 12px; margin-top: 10px;">
                    Click a direction to move the rover at that angle<br>
                    0¬∞ = Forward, 180¬∞ = Backward, 90¬∞ = Right, 270¬∞ = Left
                </p>
            </div>

            <!-- Manual Control Tab -->
            <div id="manual-tab" class="tab-content">
                <h3>‚öôÔ∏è Manual Controls</h3>
                
                <div class="duration-control">
                    <label style="margin: 0;">Forward/Backward Duration:</label>
                    <input type="number" id="duration-input" value="2" min="0.5" max="10" step="0.5">
                    <span>seconds</span>
                </div>
                
                <div class="control-grid">
                    <div></div>
                    <button class="control-btn btn" onclick="quickCommand('forward')">‚Üë</button>
                    <div></div>
                    <button class="control-btn btn" onclick="quickCommand('left')">‚Üê</button>
                    <button class="control-btn btn btn-danger" onclick="quickCommand('stop')">‚èπ</button>
                    <button class="control-btn btn" onclick="quickCommand('right')">‚Üí</button>
                    <div></div>
                    <button class="control-btn btn" onclick="quickCommand('backward')">‚Üì</button>
                    <div></div>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>üîß Settings</h3>
            <div class="form-group">
                <label>Azure Function URL:</label>
                <input type="text" id="function-url" value="https://az-tutorial.azurewebsites.net/api/http_trigger_pi">
            </div>
        </div>

        <div class="card">
            <h3>üìä Response Log</h3>
            <div id="response" class="output">üöÄ Rover Control System Ready

Available Control Modes:
‚Ä¢ üí¨ Text: Natural language commands
‚Ä¢ üé§ Voice: Speak your commands
‚Ä¢ üñºÔ∏è Image: Upload map for navigation
‚Ä¢ üß≠ Directional: 8-direction control (0¬∞-315¬∞)
‚Ä¢ ‚öôÔ∏è Manual: Arrow key controls

Ready to send commands!
</div>
            
            <div id="status" class="status" style="display: none;"></div>
            
            <button class="btn btn-small" onclick="clearLog()">Clear Log</button>
            <button class="btn btn-danger btn-small" onclick="emergencyStop()">üõë Emergency Stop</button>
        </div>
    </div>

    <script>
        let commandInProgress = false;
        let uploadedImage = null;
        let imageAnalyzed = false;
        let recognition = null;
        let isRecording = false;

        // Initialize Speech Recognition
        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = true;
                recognition.lang = 'en-US';

                recognition.onstart = function() {
                    document.getElementById('voice-status-text').textContent = 'üé§ Listening...';
                    document.getElementById('voice-btn').classList.add('recording');
                };

                recognition.onresult = function(event) {
                    let transcript = '';
                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        transcript += event.results[i][0].transcript;
                    }
                    document.getElementById('voice-transcript').textContent = transcript;
                };

                recognition.onend = function() {
                    isRecording = false;
                    document.getElementById('voice-status-text').textContent = 'Processing command...';
                    document.getElementById('voice-btn').classList.remove('recording');
                    
                    const transcript = document.getElementById('voice-transcript').textContent;
                    if (transcript && transcript !== 'None') {
                        setPrompt(transcript);
                        sendTextCommand();
                        document.getElementById('voice-status-text').textContent = 'Command sent!';
                    } else {
                        document.getElementById('voice-status-text').textContent = 'No speech detected. Try again.';
                    }
                };

                recognition.onerror = function(event) {
                    document.getElementById('voice-status-text').textContent = `Error: ${event.error}`;
                    document.getElementById('voice-btn').classList.remove('recording');
                    isRecording = false;
                };
            } else {
                addLog('‚ùå Speech recognition not supported in this browser', 'error');
                showStatus('Speech recognition not supported. Use Chrome.', 'error');
            }
        }

        function toggleVoiceRecording() {
            if (!recognition) {
                initSpeechRecognition();
            }

            if (isRecording) {
                recognition.stop();
                isRecording = false;
            } else {
                document.getElementById('voice-transcript').textContent = 'None';
                recognition.start();
                isRecording = true;
            }
        }

        function testSpeechRecognition() {
            if ('webkitSpeechRecognition' in window) {
                showStatus('‚úÖ Speech recognition available!', 'success');
                addLog('‚úÖ Microphone access granted', 'success');
            } else {
                showStatus('‚ùå Not supported. Use Chrome browser.', 'error');
                addLog('‚ùå Speech recognition not available', 'error');
            }
        }

        // Direction control
        function moveDirection(degrees) {
            const duration = parseFloat(document.getElementById('direction-duration').value) || 2;
            
            // Map degrees to movement commands
            const directionMap = {
                0: `move forward for ${duration} seconds`,
                45: `move forward for ${duration/2} seconds, turn right, move forward for ${duration/2} seconds`,
                90: `turn right`,
                135: `turn right, move backward for ${duration/2} seconds, turn right, move forward for ${duration/2} seconds`,
                180: `move backward for ${duration} seconds`,
                225: `turn left, move backward for ${duration/2} seconds, turn left, move forward for ${duration/2} seconds`,
                270: `turn left`,
                315: `move forward for ${duration/2} seconds, turn left, move forward for ${duration/2} seconds`
            };

            const command = directionMap[degrees];
            if (command) {
                setPrompt(command);
                addLog(`üß≠ Direction ${degrees}¬∞ selected`, 'info');
                sendTextCommand();
            }
        }

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');
            
            addLog(`Switched to ${tabName} mode`, 'info');
        }

        // Drag and drop handling
        const dropArea = document.getElementById('dropArea');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea?.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea?.addEventListener(eventName, () => {
                dropArea.classList.add('dragover');
            }, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropArea?.addEventListener(eventName, () => {
                dropArea.classList.remove('dragover');
            }, false);
        });

        dropArea?.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length > 0) {
                handleImageUpload({ target: { files: files } });
            }
        }

        // Image upload handling
        function handleImageUpload(event) {
            const file = event.target.files[0];
            
            if (!file) return;
            
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png'];
            if (!validTypes.includes(file.type)) {
                showStatus('Invalid file type. Please upload JPG, JPEG, or PNG', 'error');
                return;
            }

            if (file.size > 10 * 1024 * 1024) {
                showStatus('File too large. Maximum size is 10MB', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('imagePreview');
                preview.src = e.target.result;
                preview.style.display = 'block';
                
                uploadedImage = e.target.result;
                imageAnalyzed = false;
                
                document.getElementById('imageName').textContent = file.name;
                document.getElementById('imageSize').textContent = (file.size / 1024).toFixed(2) + ' KB';
                
                const img = new Image();
                img.onload = function() {
                    document.getElementById('imageDimensions').textContent = `${this.width} √ó ${this.height}px`;
                };
                img.src = e.target.result;
                
                document.getElementById('imageInfo').style.display = 'block';
                document.getElementById('analyzedImage').style.display = 'none';
                document.getElementById('send-image-command').disabled = true;
                
                addLog(`‚úÖ Image loaded: ${file.name}`, 'success');
                showStatus('Image uploaded! Click "Analyze Image" first.', 'success');
            };
            reader.readAsDataURL(file);
        }

        // Analyze image with GPT-4o Vision
        async function analyzeImage() {
            if (!uploadedImage) {
                showStatus('Please upload an image first', 'error');
                return;
            }

            const functionUrl = document.getElementById('function-url').value.trim();
            const areaWidth = parseFloat(document.getElementById('areaWidth').value) || 2.5;
            const areaHeight = parseFloat(document.getElementById('areaHeight').value) || 2.5;

            const analyzeBtn = document.getElementById('analyze-image-btn');
            analyzeBtn.textContent = 'üîÑ Analyzing...';
            analyzeBtn.disabled = true;

            addLog('üîç Analyzing image for rover, obstacles, and goal...', 'info');
            showStatus('Analyzing image...', 'info');

            const analysisPrompt = `Analyze this robot navigation image. 
            
The area is marked by black electrical tape: ${areaWidth}m wide √ó ${areaHeight}m long.

Identify and describe:
1. The ROVER/ROBOT (small wheeled robot at bottom of image)
2. The GOAL (green bottle at top of image)
3. All OBSTACLES (red basket, egg cartons, boxes, any objects to avoid)
4. Navigation boundaries (black tape lines)

Be specific about positions using top/bottom/center and left/right.`;

            try {
                const response = await fetch(functionUrl, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        "user_prompt": analysisPrompt,
                        "image": uploadedImage,
                        "analysis_only": true  // KEY: Tells Azure Function to return analysis, not commands
                    })
                });

                const data = await response.json();
                
                if (data.status === 'success' && data.analysis) {
                    const analysis = data.analysis;
                    
                    addLog('‚úÖ Image Analysis Complete:', 'success');
                    addLog(`ü§ñ Rover: ${analysis.rover_found ? '‚úÖ Found - ' + analysis.rover_position : '‚ùå Not detected'}`, analysis.rover_found ? 'success' : 'error');
                    
                    if (analysis.goal_found) {
                        addLog(`üéØ Goal: ‚úÖ Found - ${analysis.goal_description} at ${analysis.goal_position}`, 'success');
                    } else {
                        addLog(`üéØ Goal: ‚ùå Not detected`, 'error');
                    }
                    
                    if (analysis.obstacles_detected && analysis.obstacle_list) {
                        addLog(`‚ö†Ô∏è Obstacles: ${analysis.obstacle_count} detected:`, 'warning');
                        analysis.obstacle_list.forEach((obs, i) => {
                            addLog(`   ${i+1}. ${obs.type} at ${obs.position}`, 'warning');
                        });
                    } else {
                        addLog(`‚ö†Ô∏è Obstacles: None detected`, 'info');
                    }
                    
                    addLog(`üìè Boundary: ${analysis.boundary_detected ? '‚úÖ ' + analysis.boundary_description : '‚ùå Not detected'}`, 'info');
                    addLog(`üìä Assessment: ${analysis.area_assessment}`, 'info');
                    addLog(`üí° Strategy: ${analysis.recommended_approach}`, 'info');

                    if (analysis.navigation_feasible) {
                        imageAnalyzed = true;
                        document.getElementById('send-image-command').disabled = false;
                        showStatus('‚úÖ Analysis complete! Ready to navigate.', 'success');
                    } else {
                        imageAnalyzed = false;
                        showStatus('‚ö†Ô∏è Navigation not feasible with current setup.', 'warning');
                    }

                    visualizeAnalysis();
                } else {
                    addLog(`‚ùå Analysis failed: ${data.error || 'Unknown error'}`, 'error');
                    showStatus('Analysis failed. See log for details.', 'error');
                }
            } catch (error) {
                addLog(`‚ùå Error: ${error.message}`, 'error');
                showStatus(`Error: ${error.message}`, 'error');
            } finally {
                analyzeBtn.textContent = 'üîç Step 1: Analyze Image';
                analyzeBtn.disabled = false;
            }
        }

        function visualizeAnalysis() {
            const canvas = document.getElementById('analysisCanvas');
            const ctx = canvas.getContext('2d');
            const img = document.getElementById('imagePreview');

            canvas.width = img.naturalWidth;
            canvas.height = img.naturalHeight;

            ctx.drawImage(img, 0, 0);
            
            document.getElementById('analyzedImage').style.display = 'block';
            addLog('üìä Analysis visualization displayed', 'info');
        }

        async function sendImageCommand() {
            if (!imageAnalyzed) {
                showStatus('Please analyze the image first', 'warning');
                return;
            }

            const functionUrl = document.getElementById('function-url').value.trim();
            const navInstructions = document.getElementById('nav-instructions').value.trim();
            const areaWidth = parseFloat(document.getElementById('areaWidth').value) || 2.5;
            const areaHeight = parseFloat(document.getElementById('areaHeight').value) || 2.5;

            const sendButton = document.getElementById('send-image-command');
            sendButton.textContent = 'üîÑ Planning Route...';
            sendButton.disabled = true;

            const navigationPrompt = `Generate a navigation sequence for the rover based on the image.

REQUIREMENTS:
- Area: ${areaWidth}m √ó ${areaHeight}m (marked by black tape)
- Speed: 100% (approximately 0.3-0.5 m/s)
- Start: Rover position at bottom of frame
- Goal: Green bottle at top of frame
- Obstacles: Red basket, egg cartons, boxes (avoid these)

TASK: ${navInstructions}

Generate a safe movement sequence from rover to goal. Use forward/backward movements with durations, and left/right turns (no duration needed for turns).

Plan 5-12 movement steps to navigate around obstacles and reach the green bottle.`;

            addLog('üó∫Ô∏è Generating navigation plan...', 'info');

            try {
                const response = await fetch(functionUrl, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        "user_prompt": navigationPrompt,
                        "image": uploadedImage
                        // NO analysis_only flag - this should return commands
                    })
                });

                const data = await response.json();
                
                if (data.status === 'success' && data.generated_json) {
                    addLog('‚úÖ Navigation plan generated!', 'success');
                    const plan = data.generated_json;
                    
                    if (plan.command === 'sequence' && plan.commands) {
                        addLog(`üìã Generated ${plan.commands.length} movement steps:`, 'success');
                        plan.commands.forEach((cmd, i) => {
                            const movement = cmd.movement || `motor ${cmd.motor}`;
                            const duration = cmd.duration ? ` for ${cmd.duration}s` : ' (calibrated turn)';
                            addLog(`  Step ${i+1}: ${movement}${duration}`, 'info');
                        });
                        addLog(`üì° IoT Status: ${data.iot_status}`, 'success');
                        showStatus('üöÄ Navigation sequence sent to rover!', 'success');
                    } else {
                        addLog(`‚ö†Ô∏è Unexpected command structure: ${JSON.stringify(plan)}`, 'warning');
                        showStatus('Command sent but format may be unexpected', 'warning');
                    }
                } else {
                    addLog(`‚ùå Navigation failed: ${data.error || 'Unknown error'}`, 'error');
                    showStatus(`Error: ${data.error || 'Navigation generation failed'}`, 'error');
                }
            } catch (error) {
                addLog(`‚ùå Error: ${error.message}`, 'error');
                showStatus(`Error: ${error.message}`, 'error');
            } finally {
                sendButton.textContent = 'üó∫Ô∏è Step 2: Execute Navigation';
                sendButton.disabled = false;
            }
        }

        function addLog(message, type = 'info') {
            const output = document.getElementById('response');
            const timestamp = new Date().toLocaleTimeString();
            const icons = { error: '‚ùå', success: '‚úÖ', warning: '‚ö†Ô∏è', info: 'üí¨' };
            const icon = icons[type] || 'üí¨';
            
            output.textContent += `\n[${timestamp}] ${icon} ${message}`;
            output.scrollTop = output.scrollHeight;
        }

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
            setTimeout(() => status.style.display = 'none', 5000);
        }

        function setPrompt(text) {
            document.getElementById('user-prompt').value = text;
        }

        function quickCommand(direction) {
            const duration = parseFloat(document.getElementById('duration-input').value) || 2;
            
            const commands = {
                'forward': `move forward for ${duration} seconds`,
                'backward': `move backward for ${duration} seconds`, 
                'left': 'turn left',
                'right': 'turn right',
                'stop': 'stop all motors'
            };
            
            setPrompt(commands[direction]);
            sendTextCommand();
        }

        async function sendTextCommand() {
            if (commandInProgress) {
                showStatus('Command in progress, please wait...', 'warning');
                return;
            }

            let userPrompt = document.getElementById('user-prompt').value.trim();
            const functionUrl = document.getElementById('function-url').value.trim();
            
            if (!userPrompt) {
                showStatus('Please enter a command', 'error');
                return;
            }

            commandInProgress = true;
            const sendButton = document.getElementById('send-command');
            sendButton.textContent = 'üîÑ Sending...';
            sendButton.disabled = true;

            addLog(`Command: "${userPrompt}"`, 'info');
            showStatus('Sending command to rover...', 'info');

            try {
                const response = await fetch(functionUrl, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        "user_prompt": userPrompt
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                if (data.status === 'success') {
                    addLog(`‚úÖ Command sent successfully!`, 'success');
                    showStatus('Command sent to rover!', 'success');
                } else {
                    addLog(`‚ùå Error: ${data.error}`, 'error');
                    showStatus(`Error: ${data.error}`, 'error');
                }

            } catch (error) {
                addLog(`Error: ${error.message}`, 'error');
                showStatus(`Error: ${error.message}`, 'error');
            } finally {
                commandInProgress = false;
                sendButton.textContent = 'üöÄ Send Command';
                sendButton.disabled = false;
            }
        }

        function emergencyStop() {
            setPrompt('stop all motors immediately');
            sendTextCommand();
        }

        function clearLog() {
            document.getElementById('response').textContent = 'üöÄ Rover Control System Ready\n\nLog cleared.';
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.altKey) {
                switch(e.key.toLowerCase()) {
                    case 'w': quickCommand('forward'); e.preventDefault(); break;
                    case 's': quickCommand('backward'); e.preventDefault(); break;
                    case 'a': quickCommand('left'); e.preventDefault(); break;
                    case 'd': quickCommand('right'); e.preventDefault(); break;
                    case ' ': quickCommand('stop'); e.preventDefault(); break;
                }
            }
        });

        // Initialize
        addLog('System initialized with 5 control modes', 'info');
        addLog('Voice control requires Chrome browser', 'info');
    </script>
</body>
</html>
